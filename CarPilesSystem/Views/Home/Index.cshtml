
@{
    Layout = null;
}

<!DOCTYPE html>

<html>
<head>
    <meta name="viewport" content="width=device-width" />
    <title>新能源汽车充电桩导航系统</title>
    <link rel="stylesheet" href="~/Static/mui/css/mui.min.css" />
    <link rel="stylesheet" href="~/Static/mui/css/muiloading.css" />
    <script type="text/javascript" src="~/Static/mui/js/mui.min.js"></script>
    <script type="text/javascript" src="~/Static/mui/js/muiloading.js"></script>
    <script type="text/javascript" src="~/Static/jquery/jquery-3.4.1.min.js"></script>
    <script type="text/javascript" src="https://webapi.amap.com/maps?v=1.4.15&key=4ab6fc6e84057a8a81334b9f605cb941"></script>

    <script src="~/ViewScripts/Caches.js"></script>
    <script src="~/ViewScripts/Strings.js"></script>

    <style>
        #root {
            margin: 0;
            padding: 0;
            display: flex;
            width: 100vw;
            height: 100vh;
        }

        .login-false {
            width: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background-image: url("../Static/Images/backgroud.png");
            background-repeat: no-repeat;
        }

        .login-box {
            background-color: white;
            border-radius: 6px;
            box-shadow: rgb(128, 128, 128) 0px 0px 20px 0px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding-bottom: 16px;
        }

        .mui-input-group .mui-input-row:after {
            right: 15px;
        }

        .welcome {
            font-size: 25px;
            font-weight: 600;
            margin: 16px auto;
        }

        .title {
            font-size: 18px;
            font-weight: 600;
            margin: 0 auto 16px auto;
        }

        .mui-input-row .mui-input-clear ~ .mui-icon-clear, .mui-input-row .mui-input-password ~ .mui-icon-eye, .mui-input-row .mui-input-speech ~ .mui-icon-speech {
            right: 15px;
        }

        input::-ms-reveal {
            display: none;
        }

        .mui-input-row .mui-btn {
            line-height: 1.1;
            float: none;
            width: auto !important;
            padding: 7px 15px;
        }

        .mui-button-row {
            padding-top: 4px;
            max-height: 35px;
        }

        /***********登陆后***********/
        .login-true {
            display: none;
            width: 100%;
            height: 100%;
        }

        #map-panel {
            position: absolute;
            left: 0;
            right: 0;
            top: 42px;
            bottom: 0;
        }

        #map-header {
            position: absolute;
            left: 0;
            right: 0;
            top: 0;
            width: 100%;
            height: 42px;
            padding: 0 10px;
            display: flex;
            flex-flow: nowrap;
            justify-content: space-between;
            align-items: center;
            background-color: white;
            box-shadow: 0px 0px 10px 5px #666666;
        }

        .map-setbox {
            margin-top: 42px;
            z-index: 4;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            width: 100%;
            height: auto;
        }

        .mui-popover.mui-popover-action {
            min-width: 200px;
            width: auto;
            right: 0px;
            bottom: 0px;
        }

        .mui-table-view-cell > a {
            color: black !important;
        }

        a > span {
            color: black !important;
        }

        .box-outlined {
            border: 1px solid #ccc;
            border-radius: 3px;
            padding: 3px 5px;
            margin-right: 10px;
        }

        .mui-table-view-cell {
            padding: 0px;
        }

        .list-button {
            border: 0 solid red;
            width: 100%;
            height: 42px;
        }

            .list-button > .mui-icon {
                margin-right: 10px;
            }

        .mui-popover .mui-table-view .mui-table-view-cell:first-child, .mui-popover .mui-table-view .mui-table-view-cell:first-child > a:not(.mui-btn) {
            border-top-left-radius: 0;
            border-top-right-radius: 0;
        }

        .mui-popover .mui-table-view .mui-table-view-cell:last-child, .mui-popover .mui-table-view .mui-table-view-cell:last-child > a:not(.mui-btn) {
            border-bottom-right-radius: 0;
            border-bottom-left-radius: 0;
        }
    </style>
</head>
<body id="root">
    <div class="login-false">
        <div class="login-box">
            <span class="welcome">欢迎使用</span>
            <span class="title">新能源汽车充电桩导航系统</span>
            <form class="mui-input-group">
                <div class="mui-input-row">
                    <label>用户名*</label>
                    <input id="input-username" type="text" class="mui-input-clear" placeholder="请输入用户名">
                </div>
                <div class="mui-input-row">
                    <label>密码*</label>
                    <input id="input-password" type="password" class="mui-input-password" placeholder="请输入密码">
                </div>
                <div class="sign-up-box" style="display:none;">
                    <div class="mui-input-row">
                        <label>手机号*</label>
                        <input id="input-phone" type="text" class="mui-input-clear" placeholder="请输入手机号码">
                    </div>
                    <div class="mui-input-row">
                        <label>姓名</label>
                        <input id="input-name" type="text" class="mui-input-clear" placeholder="请输入真实姓名">
                    </div>
                    <div class="mui-input-row mui-row">
                        <div class="mui-col-sm-4 mui-col-xs-4">
                            <label style="width:auto">性别</label>
                        </div>
                        <div class="mui-radio mui-col-sm-3 mui-col-xs-3">
                            <label>男</label>
                            <input name="radio-sex" value="男" type="radio">
                        </div>
                        <div class="mui-radio mui-col-sm-3 mui-col-xs-3">
                            <label>女</label>
                            <input name="radio-sex" value="女" type="radio">
                        </div>
                    </div>
                    <div class="mui-input-row">
                        <label>邮箱</label>
                        <input id="input-email" type="text" class="mui-input-clear" placeholder="请输入电子邮箱">
                    </div>
                </div>

                <div class="mui-input-row mui-row">
                    <div class="mui-col-sm-6 mui-col-xs-6">
                        <div class="mui-input mui-checkbox">
                            <input id="input-remenber" name="checkbox1" value="Item 1" type="checkbox" checked>
                            <label>记住密码</label>
                        </div>
                    </div>
                    <div class="mui-col-sm-6 mui-col-xs-6">
                        <div class="mui-button-row">
                            <button id="sign-up" type="button" class="mui-btn">注册</button>
                            <button id="sign-in" type="button" class="mui-btn mui-btn-primary">登录</button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <div class="login-true">
        <div id="map-panel">
        </div>
        <div id="map-header">
            <a href="/">
                <span style="font-weight:600;">新能源汽车充电桩导航系统</span>
            </a>
            <div style="display:flex;align-items:center;">
                <button class="box-outlined" onclick="SetPilesLocation()">
                    <span class="mui-icon mui-icon-reload"></span>
                    <span>探索附近</span>
                </button>
                <button class="box-outlined">
                    <span class="mui-icon mui-icon-paperplane"></span>
                    <span>开始导航</span>
                </button>
                <button class="box-outlined">
                    <span class="mui-icon mui-icon-close"></span>
                    <span>退出登录</span>
                </button>
                <button class="box-outlined">
                    <span class="mui-icon mui-icon-contact"></span>
                    <span>管理后台</span>
                </button>
                <a id="menu-set" href="#menu">
                    <span style="font-weight:600;" class="mui-icon mui-icon-bars"></span>
                </a>
            </div>
            <div id="menu" class="mui-popover mui-popover-bottom mui-popover-action ">
                <!-- 可选择菜单 -->
                <ul class="mui-table-view">
                    <li class="mui-table-view-cell" style="padding:0;">
                        <button class="list-button" onclick="SetPilesLocation()">
                            <span class="mui-icon mui-icon-reload"></span>
                            <span>探索附近</span>
                        </button>
                    </li>
                    <li class="mui-table-view-cell">
                        <button class="list-button">
                            <span class="mui-icon mui-icon-paperplane"></span>
                            <span>开始导航</span>
                        </button>
                    </li>
                    <li class="mui-table-view-cell">
                        <button class="list-button">
                            <span class="mui-icon mui-icon-close"></span>
                            <span>退出登录</span>
                        </button>
                    </li>
                    <li class="mui-table-view-cell">
                        <button class="list-button">
                            <span class="mui-icon mui-icon-contact"></span>
                            <span>管理后台</span>
                        </button>
                    </li>
                </ul>
                <!-- 取消菜单 -->
                <ul class="mui-table-view">
                    <li class="mui-table-view-cell">
                        <button id="close-menu" class="list-button">
                            <b><span class="mui-icon mui-icon-arrowdown" style="margin-right:10px;"></span></b>
                            <span><b>取 消</b></span>
                        </button>
                    </li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        let gdMap = null;
        let gdLocation = null;
        let nowMarker = null;
        $(function () {
            document.body.onresize = (ev) => {
                MenuSet();
            }
            MenuSet();
            $("#close-menu").click(function () {
                mui('#menu').popover('hide');
            });

            let isLogin = false;
            $("#input-username").val(Caches.UserName);
            $("#input-password").val(Caches.Password);
            if (!Strings.IsNulllOrEmpty(Caches.UserName) && !Strings.IsNulllOrEmpty(Caches.Password)) {
                isLogin = true;
            }
            SetLogin(isLogin);

            // 点击注册
            $("#sign-up").click(function () {
                if ($(".sign-up-box").css("display") == "none") {
                    $(".sign-up-box").css("display", "block");
                }
                else {
                    // 提交注册
                    let username = $("#input-username").val();
                    let password = $("#input-password").val();
                    let name = $("#input-name").val();
                    let sex = $("input[name='radio-sex']:checked").val();
                    let phone = $("#input-phone").val();
                    let email = $("#input-email").val();

                    if (Strings.IsNulllOrEmpty(username)) {
                        mui.toast("请输入用户名。");
                    }
                    else if (Strings.IsNulllOrEmpty(password)) {
                        mui.toast("请输入密码");
                    }
                    else if (!Strings.IsPhoneNumber(phone)) {
                        mui.toast("请输入正确的手机号码");
                    }
                    else {
                        mui.showLoading("正在注册新用户...")
                        $.ajax({
                            type: "post",
                            url: "/Home/SignUp",
                            data: {
                                user: {
                                    UserName: username,
                                    Password: password,
                                    sex: sex,
                                    Name: name,
                                    Phone: phone,
                                    Email: email,
                                }
                            },
                            success: (res) => {
                                mui.toast(res.Message);
                                if (res.State == 0) {
                                    $(".sign-up-box").css("display", "none");
                                }
                            },
                            error: () => {
                                mui.toast("网络错误，请稍后重试。");
                            },
                            complete: () => {
                                mui.hideLoading();
                            }
                        });
                    }
                }
            });

            // 点击登录
            $("#sign-in").click(function () {
                if ($(".sign-up-box").css("display") == "block") {
                    $(".sign-up-box").css("display", "none");
                }
                else {
                    // 提交登录
                    let username = $("#input-username").val();
                    let password = $("#input-password").val();
                    if (Strings.IsNulllOrEmpty(username)) {
                        mui.toast("请输入用户名。");
                    }
                    else if (Strings.IsNulllOrEmpty(password)) {
                        mui.toast("请输入密码。");
                    }
                    else {
                        mui.showLoading("正在登录...");
                        $.ajax({
                            type: "post",
                            url: "/Home/SignIn",
                            data: { username: username, password: password },
                            success: (res) => {
                                mui.toast(res.Message);
                                if (res.State == 0) {
                                    let remeber = $("#input-remenber").prop("checked");
                                    console.log(remeber);
                                    Caches.UserName = res.Data.UserName;
                                    if (remeber) {
                                        Caches.Password = res.Data.Password;
                                    }
                                    else {
                                        Caches.Password = "";
                                    }
                                    SetLogin(true);
                                }
                            },
                            error: () => {
                                mui.toast("网络错误，请稍后重试");
                            },
                            complete: () => {
                                mui.hideLoading();
                            }
                        });
                    }
                }
            });
        });

        /** 设置登录状态 */
        function SetLogin(isLogin) {
            if (isLogin) {
                $(".login-true").css("display", "flex");
                $(".login-false").css("display", "none");
                LoadMap();
            }
            else {
                $(".login-true").css("display", "none");
                $(".login-false").css("display", "flex");
            }
        }

        /** 设置菜单显示模式 */
        function MenuSet() {
            if (document.body.clientWidth < 720) {
                $(".box-outlined").css("display", "none");
                $("#menu-set").css("display", "block");
            }
            else {
                $(".box-outlined").css("display", "block");
                $("#menu-set").css("display", "none");
                mui('#menu').popover('hide');
            }
        }

        /** 加载地图 */
        function LoadMap() {
            gdMap = new AMap.Map('map-panel', {
                zoom: 15,
            });
            AMap.plugin([
                'AMap.ToolBar',
                'AMap.Scale',
                'AMap.MouseTool',
                'AMap.Geolocation',
            ], function () {
                // 在图面添加工具条控件，工具条控件集成了缩放、平移、定位等功能按钮在内的组合控件
                gdMap.addControl(new AMap.ToolBar());

                // 在图面添加比例尺控件，展示地图在当前层级和纬度下的比例尺
                gdMap.addControl(new AMap.Scale());
                gdLocation = new AMap.Geolocation({
                    timeout: 10000,
                    enableHighAccuracy: true,
                    zoomToAccuracy: true,
                    buttonPosition: 'LB'
                })
                // 在图面添加定位控件，用来获取和展示用户主机所在的经纬度位置
                gdMap.addControl(gdLocation);
                mui.toast("正在获取当前位置...")
                gdLocation.getCurrentPosition(
                    (state, result) => {
                        if (state == "complete") {
                            nowMarker = new AMap.Marker({
                                position: result.position,
                            });
                            mui.toast("定位成功。");
                        }
                        else {
                            mui.toast("定位失败，请允许网站访问您的位置信息。");
                        }
                    },
                    () => {
                        mui.toast("定位失败，请允许网站访问您的位置信息。");
                    }
                );
            });
        };

        /** 设置附近充电桩 */
        function SetPilesLocation() {
            // 创建点覆盖物
            var marker = new AMap.Marker({
                position: new AMap.LngLat(102.671267, 25.032055),
            });
            gdMap.add(marker);
            console.log(marker);
            gdMap.setFitView([nowMarker, marker]);
        }
    </script>
</body>
</html>
